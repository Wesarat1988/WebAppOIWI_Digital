@page "/documents/edit/{Token}"
@rendermode InteractiveServer

@using System
@using System.ComponentModel.DataAnnotations
@using System.IO
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using WepAppOIWI_Digital.Services

@inject DocumentCatalogService DocumentCatalog
@inject DocumentUploadService DocumentUploader
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<WepAppOIWI_Digital.Components.Pages.DocumentEdit> Logger

<PageTitle>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</PageTitle>

<h1 class="mb-3">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</h1>

@if (isLoading)
{
    <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...</p>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="alert alert-danger" role="alert">@loadError</div>
}
else if (currentRecord is null)
{
    <div class="alert alert-warning" role="alert">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
}
else
{
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</dt>
                <dd class="col-sm-9">@(string.IsNullOrEmpty(currentRecord.DocumentCode) ? "-" : currentRecord.DocumentCode)</dd>

                <dt class="col-sm-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</dt>
                <dd class="col-sm-9">@currentDocumentTypeLabel</dd>

                <dt class="col-sm-3">‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</dt>
                <dd class="col-sm-9">
                    @if (!string.IsNullOrEmpty(viewerUrl))
                    {
                        <a href="@viewerUrl" target="_blank" rel="noopener">@currentFileName</a>
                    }
                    else
                    {
                        @currentFileName
                    }
                </dd>
            </dl>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="@statusCssClass" role="alert">@statusMessage</div>
    }

    <EditForm Model="formModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">OI/WI Name</label>
            <InputText class="form-control" @bind-Value="formModel.DisplayName" />
            <ValidationMessage For="() => formModel.DisplayName" />
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Line</label>
                <InputText class="form-control" @bind-Value="formModel.Line" />
                <ValidationMessage For="() => formModel.Line" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Station</label>
                <InputText class="form-control" @bind-Value="formModel.Station" />
                <ValidationMessage For="() => formModel.Station" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Model</label>
                <InputText class="form-control" @bind-Value="formModel.Model" />
                <ValidationMessage For="() => formModel.Model" />
            </div>
        </div>

        <div class="mb-3 mt-3">
            <label class="form-label">Machine name <span class="text-muted">(‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó WI)</span></label>
            <InputText class="form-control" @bind-Value="formModel.MachineName" />
            <ValidationMessage For="() => formModel.MachineName" />
        </div>

        <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ Upload / Update</label>
            <InputText class="form-control" @bind-Value="formModel.UploadedBy" />
            <ValidationMessage For="() => formModel.UploadedBy" />
        </div>

        <div class="mb-3">
            <label class="form-label">Comment</label>
            <InputTextArea class="form-control" rows="3" @bind-Value="formModel.Comment" />
            <ValidationMessage For="() => formModel.Comment" />
        </div>

        <div class="mb-3">
            <label class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</label>
            <InputFile OnChange="OnFileSelected"
                       accept=".pdf,.xlsx,.xls,.doc,.docx"
                       class="form-control"
                       aria-invalid="@(showTriedSave && !CanSave)">
            </InputFile>
            @if (!string.IsNullOrEmpty(selectedFileName))
            {
                <div class="form-text">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: @selectedFileName
                    <button type="button" class="btn btn-link btn-sm p-0 ms-2" @onclick="ClearFile">‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(validationMessage))
        {
            <div class="alert alert-warning alert-dismissible fade show d-flex align-items-start" role="alert" aria-live="polite" tabindex="-1" @ref="alertRef">
                <div class="me-2">‚ö†Ô∏è</div>
                <div>@validationMessage</div>
                <button type="button" class="btn-close ms-auto" @onclick="DismissValidationMessage" aria-label="Close"></button>
            </div>
        }

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" disabled="@(!CanSave || isSubmitting)">@(isSubmitting ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..." : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç")</button>
            <button type="button" class="btn btn-outline-secondary" @onclick="NavigateHome">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Home</button>
        </div>
    </EditForm>

    @* ===== History (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ===== *@
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">History (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h5>
                @if (!string.IsNullOrEmpty(historyLink))
                {
                    <a href="@historyLink" class="small">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
                }
            </div>

            @if (historyRows.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                <th>‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</th>
                                <th class="text-end">‡∏Ç‡∏ô‡∏≤‡∏î</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="text-end">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (var i = 0; i < historyRows.Count; i++)
                            {
                                var h = historyRows[i];
                                var delta = DeltaFromPrev(i);
                                var deltaLabel = delta is TimeSpan gap ? FormatDelta(gap) : null;
                                <tr>
                                    <td><code>@h.VersionLabel</code></td>
                                    <td>
                                        @h.Timestamp.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")
                                        <div class="text-muted small">
                                            (@Rel(h.Timestamp))
                                            @if (!string.IsNullOrEmpty(deltaLabel))
                                            {
                                                <span> ‚Ä¢ @deltaLabel</span>
                                            }
                                        </div>
                                    </td>
                                    <td>@h.AuthorName</td>
                                    <td class="text-truncate" style="max-width: 380px" title="@h.Comment">@h.Comment</td>
                                    <td class="text-end">@(h.SizeKb is double size ? $"{size:F1} KB" : "-")</td>
                                    <td>
                                        @if (h.IsActive)
                                        {
                                            <span class="badge bg-success">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (h.IsActive)
                                        {
                                            <button class="btn btn-sm btn-outline-success" disabled>Using</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-primary" disabled="@isSwitching" @onclick="() => UseVersionAsync(h)">‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted mb-0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</p>
            }
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(successViewerUrl))
{
    <div class="alert alert-info mt-4">
        <div>üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
        @if (!string.IsNullOrEmpty(currentRecord?.DocumentCode))
        {
            <div class="fw-bold">‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: @currentRecord!.DocumentCode</div>
        }
        <div>
            <a class="alert-link" href="@successViewerUrl" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a>
            ‡∏´‡∏£‡∏∑‡∏≠ <a class="alert-link" href="/">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Home</a>
        </div>
    </div>
}

@code {
    private const long MaxFileSize = 200 * 1024 * 1024;
    private const string FileRequiredMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: PDF/Excel/Word)";

    [Parameter]
    public string Token { get; set; } = string.Empty;

    private readonly UpdateFormModel formModel = new();
    private IBrowserFile? SelectedFile { get; set; }
    private string? selectedFileName;
    private bool showTriedSave;
    private string? validationMessage;
    private ElementReference alertRef;
    private bool shouldFocusAlert;
    private bool isSubmitting;
    private bool isLoading = true;
    private string? loadError;
    private string? statusMessage;
    private string? statusCssClass;
    private string? successViewerUrl;
    private DocumentRecord? currentRecord;
    private string? currentNormalizedPath;
    private string? currentDocumentTypeLabel;
    private string? viewerUrl;
    private string currentFileName = "-";

    private bool CanSave => SelectedFile is not null;

    // History
    private PagedResult<HistoryItem> historyPage = new(Array.Empty<HistoryItem>(), 0, 1, 5);
    private List<HistoryRow> historyRows = new();
    private bool isSwitching;
    private string? historyLink;
    private string? historyLinkCandidate;

    protected override async Task OnParametersSetAsync()
    {
        await LoadDocumentAsync();
        await LoadVersionsAsync(); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    }

    private async Task LoadDocumentAsync()
    {
        isLoading = true;
        loadError = null;
        statusMessage = null;
        statusCssClass = null;
        successViewerUrl = null;
        historyLink = null;
        historyLinkCandidate = BuildHistoryLinkCandidate();
        historyPage = new PagedResult<HistoryItem>(Array.Empty<HistoryItem>(), 0, 1, 5);
        historyRows = new List<HistoryRow>();
        SelectedFile = null;
        selectedFileName = null;
        validationMessage = null;
        showTriedSave = false;
        shouldFocusAlert = false;

        if (!DocumentCatalogService.TryDecodeDocumentToken(Token, out var normalizedPath))
        {
            loadError = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ";
            isLoading = false;
            return;
        }

        currentNormalizedPath = normalizedPath;

        try
        {
            currentRecord = await DocumentCatalog.TryGetDocumentAsync(normalizedPath);
            if (currentRecord is null)
            {
                loadError = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
                return;
            }

            ApplyRecordToForm(currentRecord);
            viewerUrl = BuildViewerUrl(normalizedPath, currentRecord.UpdatedAt);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load document for editing.");
            loadError = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyRecordToForm(DocumentRecord record)
    {
        formModel.DisplayName = ConvertPlaceholder(record.DisplayName);
        formModel.Line = ConvertPlaceholder(record.Line);
        formModel.Station = ConvertPlaceholder(record.Station);
        formModel.Model = ConvertPlaceholder(record.Model);
        formModel.MachineName = ConvertPlaceholder(record.Machine);
        formModel.UploadedBy = ConvertPlaceholder(record.UploadedBy);
        formModel.Comment = ConvertPlaceholder(record.Comment);

        var normalizedType = DocumentNumbering.NormalizeType(record.DocumentType);
        if (string.Equals(record.DocumentType, "-", StringComparison.Ordinal))
        {
            normalizedType = string.Empty;
        }

        formModel.DocumentType = string.IsNullOrEmpty(normalizedType)
            ? string.Empty
            : normalizedType;

        currentDocumentTypeLabel = string.IsNullOrEmpty(normalizedType)
            ? "-"
            : normalizedType;

        var fileName = Path.GetFileName(record.FileName ?? string.Empty);
        currentFileName = string.IsNullOrEmpty(fileName) ? "-" : fileName;
    }

    private string? BuildHistoryLinkCandidate()
    {
        if (string.IsNullOrWhiteSpace(Token))
        {
            return null;
        }

        return $"/documents/{Uri.EscapeDataString(Token)}/history";
    }

    private async Task HandleValidSubmit()
    {
        if (currentRecord is null || string.IsNullOrEmpty(currentNormalizedPath))
        {
            return;
        }

        validationMessage = null;
        showTriedSave = false;
        shouldFocusAlert = false;
        statusMessage = null;
        statusCssClass = null;
        successViewerUrl = null;

        if (SelectedFile is null)
        {
            ShowFileRequiredMessage();
            return;
        }

        isSubmitting = true;

        try
        {
            Stream updateStream;

            try
            {
                updateStream = SelectedFile.OpenReadStream(MaxFileSize);
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to open selected file for update.");
                SelectedFile = null;
                selectedFileName = null;
                SetValidationMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
                return;
            }

            DocumentUpdateResult result;

            await using (updateStream)
            {
                result = await DocumentUploader.UpdateAsync(CreateUpdateRequest(updateStream));
            }

            if (!result.Succeeded)
            {
                statusCssClass = "alert alert-danger";
                statusMessage = result.ErrorMessage ?? "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ";
                return;
            }

            if (!string.IsNullOrEmpty(result.NormalizedPath))
            {
                currentNormalizedPath = result.NormalizedPath;
            }

            statusCssClass = "alert alert-success";
            statusMessage = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
            successViewerUrl = BuildViewerUrl(currentNormalizedPath, DateTimeOffset.UtcNow);

            SelectedFile = null;
            selectedFileName = null;
            showTriedSave = false;
            validationMessage = null;
            shouldFocusAlert = false;

            await RefreshRecordAsync();
            await LoadVersionsAsync(); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task RefreshRecordAsync(bool updateForm = true)
    {
        if (string.IsNullOrEmpty(currentNormalizedPath))
        {
            return;
        }

        try
        {
            var refreshed = await DocumentCatalog.TryGetDocumentAsync(currentNormalizedPath);
            if (refreshed is not null)
            {
                currentRecord = refreshed;
                historyLinkCandidate = BuildHistoryLinkCandidate();
                UpdateHistoryLinkVisibility();

                if (updateForm)
                {
                    ApplyRecordToForm(refreshed);
                }
                else
                {
                    var fileName = Path.GetFileName(refreshed.FileName ?? string.Empty);
                    currentFileName = string.IsNullOrEmpty(fileName) ? "-" : fileName;
                }

                viewerUrl = BuildViewerUrl(currentNormalizedPath, refreshed.UpdatedAt);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to refresh document details after update.");
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs args)
    {
        validationMessage = null;
        showTriedSave = false;
        shouldFocusAlert = false;
        selectedFileName = null;
        SelectedFile = null;

        if (args.FileCount <= 0)
        {
            return;
        }

        var file = args.File;
        if (file is null)
        {
            return;
        }

        if (file.Size <= 0)
        {
            SetValidationMessage(FileRequiredMessage);
            return;
        }

        if (file.Size > MaxFileSize)
        {
            SetValidationMessage($"‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô {MaxFileSize / (1024 * 1024)} MB");
            return;
        }

        SelectedFile = file;
        selectedFileName = file.Name;
    }

    private Task ClearFile()
    {
        ShowFileRequiredMessage();
        return Task.CompletedTask;
    }

    private void DismissValidationMessage()
    {
        validationMessage = null;
        showTriedSave = false;
        shouldFocusAlert = false;
    }

    private void ShowFileRequiredMessage()
    {
        SelectedFile = null;
        selectedFileName = null;
        SetValidationMessage(FileRequiredMessage);
    }

    private void SetValidationMessage(string message)
    {
        validationMessage = message;
        showTriedSave = true;
        shouldFocusAlert = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (shouldFocusAlert && !string.IsNullOrEmpty(validationMessage))
        {
            shouldFocusAlert = false;
            try
            {
                await JS.InvokeVoidAsync("blazorFocus", alertRef);
            }
            catch (JSException)
            {
                // no-op: focus helper unavailable
            }
            catch (InvalidOperationException)
            {
                // component disposed before focus
            }
        }
    }

    private static string ConvertPlaceholder(string? value)
        => string.Equals(value, "-", StringComparison.Ordinal)
            ? string.Empty
            : value ?? string.Empty;

    private static string? BuildViewerUrl(string? normalizedPath, DateTimeOffset? updatedAt)
    {
        if (string.IsNullOrWhiteSpace(normalizedPath))
        {
            return null;
        }

        try
        {
            var token = DocumentCatalogService.EncodeDocumentToken(normalizedPath);
            var stamp = (updatedAt?.UtcTicks ?? DateTimeOffset.UtcNow.UtcTicks).ToString();
            return $"/documents/viewer/{Uri.EscapeDataString(token)}?v={stamp}";
        }
        catch
        {
            return null;
        }
    }

    private void NavigateHome()
        => Navigation.NavigateTo("/");

    private DocumentUpdateRequest CreateUpdateRequest(Stream? content)
        => new(
            NormalizedPath: currentNormalizedPath!,
            DisplayName: formModel.DisplayName!,
            DocumentType: formModel.DocumentType ?? string.Empty,
            Line: formModel.Line,
            Station: formModel.Station,
            Model: formModel.Model,
            MachineName: formModel.MachineName,
            UploadedBy: formModel.UploadedBy,
            Comment: formModel.Comment,
            Content: content,
            UpdatedAt: DateTimeOffset.UtcNow);

    private sealed class UpdateFormModel : IValidatableObject
    {
        [Required(ErrorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")]
        [StringLength(200, ErrorMessage = "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? DisplayName { get; set; }

        public string? DocumentType { get; set; }

        [StringLength(100, ErrorMessage = "Line ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Line { get; set; }

        [StringLength(100, ErrorMessage = "Station ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Station { get; set; }

        [StringLength(100, ErrorMessage = "Model ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Model { get; set; }

        [StringLength(100, ErrorMessage = "Machine name ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? MachineName { get; set; }

        [StringLength(100, ErrorMessage = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ Upload ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? UploadedBy { get; set; }

        [StringLength(500, ErrorMessage = "Comment ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Comment { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (string.Equals(DocumentType, DocumentNumbering.DocumentTypeWi, StringComparison.OrdinalIgnoreCase)
                && string.IsNullOrWhiteSpace(MachineName))
            {
                yield return new ValidationResult(
                    "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Machine name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ WI",
                    new[] { nameof(MachineName) });
            }
        }
    }

    private async Task LoadVersionsAsync()
    {
        if (string.IsNullOrEmpty(currentNormalizedPath))
        {
            historyPage = new PagedResult<HistoryItem>(Array.Empty<HistoryItem>(), 0, 1, 5);
            historyRows = new List<HistoryRow>();
            UpdateHistoryLinkVisibility();
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            historyPage = await DocumentUploader.GetHistoryPageAsync(currentNormalizedPath!, 1, 5, null);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load version history for {Path}.", currentNormalizedPath);
            historyPage = new PagedResult<HistoryItem>(Array.Empty<HistoryItem>(), 0, 1, 5);
        }

        historyRows = BuildHistoryRows(historyPage.Items);
        UpdateHistoryLinkVisibility();
        await InvokeAsync(StateHasChanged);
    }

    private List<HistoryRow> BuildHistoryRows(IReadOnlyList<HistoryItem> source)
    {
        if (source is null || source.Count == 0)
        {
            return new List<HistoryRow>();
        }

        var ordered = source
            .OrderByDescending(v => v.TimestampUtc)
            .ThenByDescending(v => v.VersionId, StringComparer.Ordinal)
            .Take(5)
            .ToList();

        var rows = new List<HistoryRow>(ordered.Count);

        foreach (var item in ordered)
        {
            var label = string.IsNullOrWhiteSpace(item.VersionLabel) ? "-" : item.VersionLabel.Trim();
            var author = string.IsNullOrWhiteSpace(item.AuthorName) ? "-" : item.AuthorName!.Trim();
            var comment = string.IsNullOrWhiteSpace(item.Comment) ? "-" : item.Comment!.Trim();

            rows.Add(new HistoryRow(
                item.VersionId,
                label,
                item.TimestampUtc,
                author,
                comment,
                item.SizeKb,
                item.IsActive));
        }

        return rows;
    }

    private void UpdateHistoryLinkVisibility()
    {
        historyLink = historyPage.TotalCount > historyPage.PageSize && !string.IsNullOrEmpty(historyLinkCandidate)
            ? historyLinkCandidate
            : null;
    }

    private static string Rel(DateTimeOffset timestamp)
    {
        var diff = DateTimeOffset.Now - timestamp;
        if (diff < TimeSpan.Zero)
        {
            diff = TimeSpan.Zero;
        }

        if (diff.TotalSeconds < 60)
        {
            var seconds = Math.Max(0, (int)Math.Round(diff.TotalSeconds));
            return $"{seconds}s ago";
        }

        if (diff.TotalMinutes < 60)
        {
            return $"{(int)Math.Round(diff.TotalMinutes)}m ago";
        }

        if (diff.TotalHours < 24)
        {
            return $"{(int)Math.Round(diff.TotalHours)}h ago";
        }

        return $"{(int)Math.Round(diff.TotalDays)}d ago";
    }

    private TimeSpan? DeltaFromPrev(int index)
        => index + 1 < historyRows.Count
            ? historyRows[index].Timestamp - historyRows[index + 1].Timestamp
            : null;

    private static string FormatDelta(TimeSpan delta)
    {
        var span = delta.Duration();

        if (span.TotalSeconds < 60)
        {
            return $"Œî {(int)Math.Round(span.TotalSeconds)}s from prev.";
        }

        if (span.TotalMinutes < 60)
        {
            return $"Œî {(int)Math.Round(span.TotalMinutes)}m from prev.";
        }

        if (span.TotalHours < 24)
        {
            var hours = (int)Math.Floor(span.TotalHours);
            var minutes = span.Minutes;
            return minutes > 0
                ? $"Œî {hours}h {minutes}m from prev."
                : $"Œî {hours}h from prev.";
        }

        var days = (int)Math.Floor(span.TotalDays);
        var remainderHours = span.Hours;
        return remainderHours > 0
            ? $"Œî {days}d {remainderHours}h from prev."
            : $"Œî {days}d from prev.";
    }

    private async Task UseVersionAsync(HistoryRow row)
    {
        if (row.IsActive || string.IsNullOrEmpty(currentNormalizedPath))
        {
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô {row.VersionLabel}?");
        if (!confirmed)
        {
            return;
        }

        isSwitching = true;
        statusCssClass = null;
        statusMessage = null;

        try
        {
            var result = await DocumentUploader.SetActiveVersionAsync(
                normalizedPath: currentNormalizedPath!,
                versionId: row.VersionId,
                actor: formModel.UploadedBy ?? currentRecord?.UploadedBy,
                comment: null);

            if (!result.Succeeded)
            {
                statusCssClass = "alert alert-danger";
                statusMessage = result.ErrorMessage ?? "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ";
                return;
            }

            if (!string.IsNullOrEmpty(result.NormalizedPath))
            {
                currentNormalizedPath = result.NormalizedPath;
            }

            await RefreshRecordAsync(updateForm: false);
            await LoadVersionsAsync();

            var stamp = result.UpdatedAtUtc ?? currentRecord?.UpdatedAt ?? DateTimeOffset.UtcNow;
            viewerUrl = BuildViewerUrl(currentNormalizedPath, stamp);

            statusCssClass = "alert alert-success";
            statusMessage = $"‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô {row.VersionLabel} ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to set active version for {Path}", currentNormalizedPath);
            statusCssClass = "alert alert-danger";
            statusMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ";
        }
        finally
        {
            isSwitching = false;
        }
    }

    private sealed record HistoryRow(
        string VersionId,
        string VersionLabel,
        DateTimeOffset Timestamp,
        string AuthorName,
        string Comment,
        double? SizeKb,
        bool IsActive);
}
