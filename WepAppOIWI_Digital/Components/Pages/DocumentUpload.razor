@page "/documents/new"
@rendermode InteractiveServer
@using System.Collections.Generic
@using System.ComponentModel.DataAnnotations
@inject DocumentUploadService DocumentUploader
@inject NavigationManager Navigation
@inject ILogger<WepAppOIWI_Digital.Components.Pages.DocumentUpload> Logger

<PageTitle>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</PageTitle>

<h1 class="page-title">
    <i class="bi bi-file-earmark-plus-fill me-2" style="font-size:32px; line-height:1; transform:translateY(2px);"></i>
    Add OI/WI Document
</h1>

@if (isLoadingDocumentNumbers)
{
    <div class="alert alert-secondary d-inline-flex align-items-center gap-2" role="status">
        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó OI ‡πÅ‡∏•‡∏∞ WI...</span>
    </div>
}
else
{
    if (!string.IsNullOrEmpty(documentNumberError))
    {
        <div class="alert alert-warning" role="alert">@documentNumberError</div>
    }

    <div class="mb-3">
        <div class="alert @AlertToneClass d-inline-flex align-items-center gap-2" role="status">
            <span>‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (@SelectedTypeLabel):</span>
            @if (!string.IsNullOrEmpty(SelectedPreviewCode))
            {
                <strong>@SelectedPreviewCode</strong>
            }
            else
            {
                <span class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            }
        </div>
    </div>
}


<p class="text-muted">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="@statusCssClass" role="alert">@statusMessage</div>
}

<EditForm Model="formModel" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>

        <InputSelect class="form-select"
                     Value="formModel.DocumentType"
                     ValueChanged="@(async (string? val) => await OnDocumentTypeChanged(val))"
                     ValueExpression="() => formModel.DocumentType">
            @foreach (var documentType in DocumentNumbering.KnownTypes)
            {
                <option value="@documentType">@documentType</option>
            }
        </InputSelect>

        <ValidationMessage For="() => formModel.DocumentType" />
    </div>

    <div class="mb-3">
        <label class="form-label">OI/WI Name</label>
        <InputText class="form-control" @bind-Value="formModel.DisplayName" />
        <ValidationMessage For="() => formModel.DisplayName" />
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Line</label>
            <InputText class="form-control" @bind-Value="formModel.Line" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Station</label>
            <InputText class="form-control" @bind-Value="formModel.Station" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Model</label>
            <InputText class="form-control" @bind-Value="formModel.Model" />
        </div>
    </div>

    <div class="mb-3 mt-3">
        <label class="form-label">Machine name <span class="text-muted">(‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó WI)</span></label>
        <InputText class="form-control"
                   placeholder="‡πÉ‡∏™‡πà Machine name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ WI"
                   @bind-Value="formModel.MachineName" />
        <ValidationMessage For="() => formModel.MachineName" />
    </div>

    <div class="mb-3 mt-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ Upload / Update</label>
        <InputText class="form-control" @bind-Value="formModel.UploadedBy" />
    </div>

    <div class="mb-3">
        <label class="form-label">Comment</label>
        <InputTextArea class="form-control" @bind-Value="formModel.Comment" rows="3" />
        <ValidationMessage For="() => formModel.Comment" />
    </div>

    <div class="mb-3">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</label>
        <InputFile OnChange="HandleFileSelected" />
        @if (!string.IsNullOrEmpty(selectedFileName))
        {
            <div class="form-text">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: @selectedFileName</div>
        }
        @if (!string.IsNullOrEmpty(fileError))
        {
            <div class="text-danger">@fileError</div>
        }
    </div>

    <div class="d-flex align-items-center">
        <button type="submit" class="btn btn-primary" disabled="@(isSubmitting || selectedFile is null)">
            @(isSubmitting ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..." : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")
        </button>
        <button type="button" class="btn btn-outline-secondary ms-2" @onclick="NavigateHome">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(successViewerUrl))
{
    <div class="alert alert-info mt-4">
        <div>üìÑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
        @if (!string.IsNullOrEmpty(lastAssignedDocumentCode))
        {
            <div class="fw-bold">‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: @lastAssignedDocumentCode</div>
        }
        <div>
            <a class="alert-link" href="@successViewerUrl" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a>
            ‡∏´‡∏£‡∏∑‡∏≠ <a class="alert-link" href="/">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Home</a>
        </div>
    </div>
}

@code {
    private const long MaxFileSize = 200 * 1024 * 1024;
    private readonly UploadFormModel formModel = new();
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private string? fileError;
    private string? statusMessage;
    private string? statusCssClass;
    private string? successViewerUrl;
    private bool isSubmitting;
    private readonly Dictionary<string, string?> nextDocumentCodes = new(StringComparer.OrdinalIgnoreCase);
    private string? documentNumberError;
    private bool isLoadingDocumentNumbers;
    private string? lastAssignedDocumentCode;
    private int documentNumberRequestId;
    private string SelectedTypeLabel => ResolveDocumentTypeLabel(formModel.DocumentType);
    private string? SelectedPreviewCode => GetDocumentCodeForType(formModel.DocumentType);

    private string AlertToneClass =>
    NormalizeDocumentTypeOrDefault(formModel.DocumentType) == DocumentNumbering.DocumentTypeWi
        ? "alert-info"
        : "alert-primary";

    protected override async Task OnInitializedAsync()
    {
        // normalize ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        formModel.DocumentType = NormalizeDocumentTypeOrDefault(formModel.DocumentType);
        await UpdateDocumentNumberPreviewAsync(notifyStart: false);
    }


    private async Task HandleValidSubmit()
    {
        fileError = null;
        statusMessage = null;
        statusCssClass = null;
        successViewerUrl = null;
        lastAssignedDocumentCode = null;

        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
        var normalizedDocumentType = NormalizeDocumentTypeOrDefault(formModel.DocumentType);

        if (selectedFile is null)
        {
            fileError = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
            return;
        }

        isSubmitting = true;

        try
        {
            await using var stream = selectedFile.OpenReadStream(MaxFileSize);

            var request = new DocumentUploadRequest(
                DisplayName: formModel.DisplayName!,
                DocumentType: normalizedDocumentType,       // << ‡πÉ‡∏ä‡πâ‡∏ä‡∏ô‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                Line: formModel.Line,
                Station: formModel.Station,
                Model: formModel.Model,
                MachineName: formModel.MachineName,
                UploadedBy: formModel.UploadedBy,
                Comment: formModel.Comment,
                OriginalFileName: selectedFile.Name,
                Content: stream,
                UploadedAt: DateTimeOffset.UtcNow);

            var result = await DocumentUploader.UploadAsync(request);

            if (!result.Succeeded)
            {
                statusMessage = result.ErrorMessage ?? "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                statusCssClass = "alert alert-danger";
                return;
            }

            statusMessage = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            statusCssClass = "alert alert-success";
            lastAssignedDocumentCode = result.DocumentCode;

            if (!string.IsNullOrWhiteSpace(result.NormalizedPath))
            {
                try
                {
                    var token = DocumentCatalogService.EncodeDocumentToken(result.NormalizedPath);
                    successViewerUrl = $"/documents/viewer/{Uri.EscapeDataString(token)}";
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to build viewer link for the uploaded document '{Document}'.", result.NormalizedPath);
                }
            }

            // ‡∏Ñ‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å WI ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô WI)
            var keepType = formModel.DocumentType;
            formModel.Reset(keepType);
            selectedFile = null;
            selectedFileName = null;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            await UpdateDocumentNumberPreviewAsync();
        }
        catch (IOException ex)
        {
            Logger.LogError(ex, "Failed to upload document due to I/O error.");
            statusMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
            statusCssClass = "alert alert-danger";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error while uploading document.");
            statusMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            statusCssClass = "alert alert-danger";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs args)
    {
        fileError = null;
        selectedFile = args.File;
        selectedFileName = selectedFile?.Name;

        if (selectedFile is not null && selectedFile.Size > MaxFileSize)
        {
            fileError = $"‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô {MaxFileSize / (1024 * 1024)} MB";
            selectedFile = null;
            selectedFileName = null;
        }
    }

    private void NavigateHome()
    {
        Navigation.NavigateTo("/");
    }

    private async Task UpdateDocumentNumberPreviewAsync(bool notifyStart = true)
    {
        var requestId = System.Threading.Interlocked.Increment(ref documentNumberRequestId);
        documentNumberError = null;
        nextDocumentCodes.Clear();

        isLoadingDocumentNumbers = true;
        if (notifyStart) await InvokeAsync(StateHasChanged);

        try
        {
            var failedTypes = new List<string>();

            foreach (var documentType in DocumentNumbering.KnownTypes)
            {
                var normalizedType = NormalizeDocumentTypeOrDefault(documentType);
                var preview = await DocumentUploader.GetNextDocumentCodeAsync(normalizedType);

                if (requestId != System.Threading.Volatile.Read(ref documentNumberRequestId)) return;

                if (!string.IsNullOrEmpty(preview))
                    nextDocumentCodes[normalizedType] = preview;
                else
                    failedTypes.Add(normalizedType);
            }

            if (requestId != System.Threading.Volatile.Read(ref documentNumberRequestId)) return;

            if (failedTypes.Count == DocumentNumbering.KnownTypes.Count)
                documentNumberError = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå";
            else if (failedTypes.Count > 0)
                documentNumberError = $"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {string.Join(", ", failedTypes.Select(ResolveDocumentTypeLabel))}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to compute next document numbers for known types.");
            if (requestId != System.Threading.Volatile.Read(ref documentNumberRequestId)) return;
            documentNumberError = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
        }
        finally
        {
            if (requestId == System.Threading.Volatile.Read(ref documentNumberRequestId))
            {
                isLoadingDocumentNumbers = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private string? GetDocumentCodeForType(string documentType)
    {
        var normalized = NormalizeDocumentTypeOrDefault(documentType);
        return nextDocumentCodes.TryGetValue(normalized, out var code) ? code : null;
    }

    private string GetDocumentTypeAlertClass(string documentType)
    {
        var normalized = NormalizeDocumentTypeOrDefault(documentType);
        var isSelected = string.Equals(formModel.DocumentType, normalized, StringComparison.OrdinalIgnoreCase);
        var tone = isSelected ? "alert-primary" : "alert-info";
        return $"alert {tone} d-inline-flex align-items-center gap-2";
    }

    private static string ResolveDocumentTypeLabel(string? value)
        => NormalizeDocumentTypeOrDefault(value);

    private static string NormalizeDocumentTypeOrDefault(string? value)
    {
        var normalized = DocumentNumbering.NormalizeType(value);

        if (!DocumentNumbering.IsKnownType(normalized))
        {
            return DocumentNumbering.DocumentTypeOi;
        }

        return normalized;
    }

    private sealed class UploadFormModel : IValidatableObject
    {
        [Required(ErrorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")]
        [StringLength(200, ErrorMessage = "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? DisplayName { get; set; }

        [Required(ErrorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")]
        public string? DocumentType { get; set; } = DocumentNumbering.DocumentTypeOi;

        [StringLength(100, ErrorMessage = "Line ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Line { get; set; }

        [StringLength(100, ErrorMessage = "Station ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Station { get; set; }

        [StringLength(100, ErrorMessage = "Model ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Model { get; set; }

        [StringLength(100, ErrorMessage = "Machine name ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? MachineName { get; set; }

        [StringLength(100, ErrorMessage = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ Upload ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? UploadedBy { get; set; }

        [StringLength(500, ErrorMessage = "Comment ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")]
        public string? Comment { get; set; }

        public void Reset(string? keepDocumentType = null)
        {
            DisplayName = null;

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏Å‡πá ‚Äú‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‚Äù ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô OI
            DocumentType = keepDocumentType ?? DocumentType;

            Line = null;
            Station = null;
            Model = null;
            MachineName = null;
            UploadedBy = null;
            Comment = null;
        }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (string.Equals(DocumentType, DocumentNumbering.DocumentTypeWi, System.StringComparison.OrdinalIgnoreCase)
                && string.IsNullOrWhiteSpace(MachineName))
            {
                yield return new ValidationResult(
                    "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Machine name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ WI",
                    new[] { nameof(MachineName) });
            }
        }
    }

    private async Task OnDocumentTypeChanged(string? newValue)
    {
        // normalize ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        formModel.DocumentType = NormalizeDocumentTypeOrDefault(newValue);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        await UpdateDocumentNumberPreviewAsync();

        // ‡πÉ‡∏´‡πâ UI ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡∏à‡∏£‡∏¥‡∏á ‡πÜ UpdateDocumentNumberPreviewAsync ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å StateHasChanged ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        StateHasChanged();
    }

}
