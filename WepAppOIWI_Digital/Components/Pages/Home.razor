@page "/"
@page "/oiwi"
@rendermode InteractiveServer
@using System.Globalization
@using System.IO
@using System.Linq
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using WepAppOIWI_Digital.Services
@inject DocumentCatalogService DocumentCatalog
@inject IOiwiIndexingService IndexingService
@inject ILogger<WepAppOIWI_Digital.Components.Pages.Home> Logger
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Home</PageTitle>

<div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div>
        <h1 class="mb-1">üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</h1>
        <p class="text-muted mb-0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ö‡∏ô Server Local</p>
    </div>

    <div class="d-flex gap-2 mt-2 mt-sm-0">
        <button type="button" class="btn btn-outline-secondary" @onclick="RefreshNow">
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        </button>
        <NavLink class="btn btn-primary" href="/documents/new">
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI
        </NavLink>
    </div>
</div>

<div class="search-toolbar card mb-3 shadow-sm">
    <div class="card-header pb-0">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a class="nav-link active" id="search-tab" data-bs-toggle="tab" href="#searchTab" role="tab" aria-controls="searchTab" aria-selected="true">
                    üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </a>
            </li>
        </ul>
    </div>
    <div class="card-body tab-content pt-3">
        <div class="tab-pane fade show active" id="searchTab" role="tabpanel" aria-labelledby="search-tab">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-lg-6">
                    <label class="form-label visually-hidden" for="documentSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                    <input id="documentSearch"
                           class="form-control"
                           placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Line ‡∏´‡∏£‡∏∑‡∏≠ Model"
                           value="@searchTerm"
                           @oninput="OnSearchInput" />
                </div>
                <div class="col-auto d-flex align-items-center gap-2">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#filterModal"
                            title="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                        <span aria-hidden="true">‚öôÔ∏è</span>
                        <span class="visually-hidden">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                    </button>
                    <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick="ClearAllFilters"
                            disabled="@IsClearDisabled()">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                </div>
                <div class="col-12">
                    <small class="text-muted">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, Line, Station, Model, Machine name, ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞ Comment
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row g-3">
                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label" for="typeFilter">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <select id="typeFilter" class="form-select" value="@selectedDocumentType" @onchange="OnDocumentTypeChanged">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                @foreach (var docType in GetAvailableDocumentTypes())
                                {
                                    <option value="@docType" selected="@string.Equals(docType, selectedDocumentType, StringComparison.OrdinalIgnoreCase)">@docType</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label" for="lineFilter">Line</label>
                            <select id="lineFilter" class="form-select" value="@selectedLine" @onchange="OnLineChanged">
                                <option value="">‡∏ó‡∏∏‡∏Å Line</option>
                                @foreach (var line in GetAvailableLines())
                                {
                                    <option value="@line" selected="@string.Equals(line, selectedLine, StringComparison.OrdinalIgnoreCase)">@line</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label" for="stationFilter">Station</label>
                            <select id="stationFilter" class="form-select" value="@selectedStation" @onchange="OnStationChanged">
                                <option value="">‡∏ó‡∏∏‡∏Å Station</option>
                                @foreach (var station in GetAvailableStations())
                                {
                                    <option value="@station" selected="@string.Equals(station, selectedStation, StringComparison.OrdinalIgnoreCase)">@station</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label" for="modelFilter">Model</label>
                            <select id="modelFilter" class="form-select" value="@selectedModel" @onchange="OnModelChanged">
                                <option value="">‡∏ó‡∏∏‡∏Å Model</option>
                                @foreach (var model in GetAvailableModels())
                                {
                                    <option value="@model" selected="@string.Equals(model, selectedModel, StringComparison.OrdinalIgnoreCase)">@model</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label" for="uploaderFilter">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                            <select id="uploaderFilter" class="form-select" value="@selectedUploader" @onchange="OnUploaderChanged">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
                                @foreach (var uploader in GetAvailableUploaders())
                                {
                                    <option value="@uploader" selected="@string.Equals(uploader, selectedUploader, StringComparison.OrdinalIgnoreCase)">@uploader</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @onclick="ClearAllFilters">
                    ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="ApplyFiltersFromModal">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                </button>
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(activeDirectoryPath))
{
    <p class="small text-muted mb-2">‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <code>@activeDirectoryPath</code></p>
}

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="@statusAlertClass" role="alert">@statusMessage</div>
}

@if (!string.IsNullOrEmpty(storageNoteMessage))
{
    <div class="alert alert-secondary small py-2 mb-3" role="status">@storageNoteMessage</div>
}

@if (isLoading)
{
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th style="width:72px;">No.</th>
                    <th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                    <th>OI/WI Name</th>
                    <th>Line</th>
                    <th>Station</th>
                    <th>Model</th>
                    <th>Machine name</th>
                    <th>Time</th>
                    <th>Name</th>
                    <th>Stamp info</th>
                    <th>Comment</th>
                    <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
                @for (var i = 0; i < 10; i++)
                {
                    <tr class="skeleton-row">
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                        <td><div class="sk w-100"></div></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="text-muted small mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶ ‡∏´‡∏≤‡∏Å‡∏ô‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤</div>
    @if (showSlowMessage)
    {
        <div class="text-muted small mt-1">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‚Ä¶</div>
    }
}
else if (isError)
{
    <div class="alert alert-warning d-flex align-items-start" role="alert">
        <div class="me-2">‚ö†Ô∏è</div>
        <div>@(string.IsNullOrWhiteSpace(errorMessage) ? "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ" : errorMessage)</div>
        <button class="btn btn-sm btn-outline-secondary ms-auto" @onclick="RetryAsync">‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </div>
}
else
{
    <div id="oiwiTableTop"></div>

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <div class="small text-muted">
            Showing <strong>@StartIndex‚Äì@EndIndex</strong> of <strong>@pageData.TotalCount</strong>
        </div>

        <div class="d-flex align-items-center gap-2">
            <label class="form-label m-0 small">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</label>
            <select class="form-select form-select-sm" style="width: 96px" value="@currentPageSize" @onchange="ChangePageSize">
                @foreach (var s in pageSizes)
                {
                    <option value="@s">@s</option>
                }
            </select>
        </div>

        <nav aria-label="Pagination">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(pageData.Page <= 1 ? "disabled" : null)">
                    <button class="page-link" aria-label="First" @onclick="() => Go(1)">¬´ First</button>
                </li>
                <li class="page-item @(pageData.Page <= 1 ? "disabled" : null)">
                    <button class="page-link" aria-label="Previous" @onclick="() => Go(pageData.Page - 1)">‚Äπ Prev</button>
                </li>

                @foreach (var pnum in GetPageList())
                {
                    if (pnum is null)
                    {
                        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
                    }
                    else
                    {
                        var active = pnum == pageData.Page ? "active" : null;
                        <li class="page-item @active">
                            <button id="oiwi-pagebtn-@pnum"
                                    class="page-link"
                                    aria-label="Page @pnum"
                                    disabled="@(pnum == pageData.Page)"
                                    @onclick="() => Go(pnum.Value)">
                                @pnum
                            </button>
                        </li>
                    }
                }

                <li class="page-item @(pageData.Page >= LastPage ? "disabled" : null)">
                    <button class="page-link" aria-label="Next" @onclick="() => Go(pageData.Page + 1)">Next ‚Ä∫</button>
                </li>
                <li class="page-item @(pageData.Page >= LastPage ? "disabled" : null)">
                    <button class="page-link" aria-label="Last" @onclick="() => Go(LastPage)">Last ¬ª</button>
                </li>
            </ul>
        </nav>

        <div class="input-group input-group-sm" style="width: 200px">
            <span class="input-group-text">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤</span>
            <input class="form-control"
                   type="number"
                   min="1"
                   max="@LastPage"
                   value="@JumpInput"
                   @oninput="OnJumpInputChanged"
                   @onkeydown="OnJumpInputKeyDown" />
            <button class="btn btn-outline-secondary" type="button" @onclick="Jump">Go</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col" style="width: 70px;">No.</th>
                    <th scope="col" style="width: 160px;">‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                    <th scope="col">OI/WI Name</th>
                    <th scope="col">Line</th>
                    <th scope="col">Station</th>
                    <th scope="col">Model</th>
                    <th scope="col">Machine name</th>
                    <th scope="col">Time</th>
                    <th scope="col">Name</th>
                    <th scope="col">Stamp info</th>
                    <th scope="col">Comment</th>
                    <th scope="col" class="text-center" style="width: 140px;">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
                @if (pageData.Items.Count == 0)
                {
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            @(documents.Count == 0
                                ? "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•"
                                : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")
                        </td>
                    </tr>
                }
                else
                {
                    @for (var index = 0; index < pageData.Items.Count; index++)
                    {
                        var row = pageData.Items[index];
                        var rowNumber = StartIndex + index;
                        var viewerUrl = BuildViewerUrl(row);
                        var editUrl = BuildEditUrl(row);
                        <tr>
                            <td>@rowNumber</td>
                            <td>@(DisplayOrDash(row.DocumentCode))</td>
                            <td>
                                @if (!string.IsNullOrEmpty(viewerUrl))
                                {
                                    <a href="@viewerUrl" target="_blank" rel="noopener">@row.DisplayName</a>
                                }
                                else if (!string.IsNullOrEmpty(row.LinkUrl))
                                {
                                    <a href="@row.LinkUrl" target="_blank" rel="noopener">@row.DisplayName</a>
                                }
                                else
                                {
                                    @row.DisplayName
                                }
                            </td>
                            <td>@(DisplayOrDash(row.Line))</td>
                            <td>@(DisplayOrDash(row.Station))</td>
                            <td>@(DisplayOrDash(row.Model))</td>
                            <td>@(DisplayOrDash(row.Machine))</td>
                            <td>@FormatTimestamp(row.UpdatedAt)</td>
                            <td>@(DisplayOrDash(row.UploadedBy))</td>
                            <td>@FormatStampInfo(row.StampMode, row.StampDate)</td>
                            <td>@(DisplayOrDash(row.Comment))</td>
                            <td class="text-center">
                                @if (!string.IsNullOrEmpty(editUrl))
                                {
                                    <NavLink class="btn btn-sm btn-outline-primary" href="@editUrl">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</NavLink>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

