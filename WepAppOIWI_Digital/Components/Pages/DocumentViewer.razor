@page "/documents/viewer/{Token}"
@rendermode InteractiveServer
@using System
@using System.Linq
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject DocumentCatalogService DocumentCatalog
@inject NavigationManager Navigation
@inject ILogger<WepAppOIWI_Digital.Components.Pages.DocumentViewer> Logger
@inject IJSRuntime JSRuntime

<PageTitle>‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</PageTitle>

<h1 class="mb-3">üëÅÔ∏è‚Äçüó®Ô∏è ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}
else if (isLoading)
{
    <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</p>
}
else if (document is null || fileHandle is null)
{
    <div class="alert alert-warning" role="alert">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á</div>
}
else
{
    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                    <h2 class="card-title h4 mb-1">@document.DisplayName</h2>
                    <p class="card-subtitle text-muted small mb-0">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: @FormatTimestamp(document.UpdatedAt)</p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-primary" href="@(downloadSource ?? "#")" target="_blank" rel="noopener" download="@fileHandle?.FileName">
                        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                    </a>
                    <button type="button" class="btn btn-secondary" @onclick="NavigateHome">
                        ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>
            </div>
            <hr />
            <dl class="row mb-0">
                <dt class="col-sm-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.DocumentType)</dd>
                <dt class="col-sm-3">‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.DocumentCode)</dd>
                <dt class="col-sm-3">Line</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Line)</dd>
                <dt class="col-sm-3">Station</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Station)</dd>
                <dt class="col-sm-3">Model</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Model)</dd>
                <dt class="col-sm-3">Machine name</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Machine)</dd>
                <dt class="col-sm-3">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.UploadedBy)</dd>
                <dt class="col-sm-3">Comment</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Comment)</dd>
                <dt class="col-sm-3">Stamp info</dt>
                <dd class="col-sm-9">
                    @if (document.StampMode != StampMode.None)
                    {
                        <span class="badge rounded-pill bg-danger stamp-badge">@FormatStampInfo(document.StampMode, document.StampDate)</span>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </dd>
                <dt class="col-sm-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå</dt>
                <dd class="col-sm-9">@fileHandle.ContentType</dd>
            </dl>
        </div>
    </div>

    @if (canPreviewInline && !string.IsNullOrEmpty(previewSource))
    {
        <div class="document-preview-frame border rounded">
            <div class="document-viewer">
                <!-- PDF Toolbar -->
                <div class="document-toolbar d-flex align-items-center gap-2 p-2 border-bottom bg-light">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ZoomOut" aria-label="‡∏ã‡∏π‡∏°‡∏≠‡∏≠‡∏Å">‚àí</button>
                    <span id="@($"{pdfContainerId}-scale")" class="small">100%</span>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ZoomIn" aria-label="‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤">+</button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="FitWidth" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á">Fit width</button>
                    <button class="btn btn-sm btn-outline-secondary ms-auto" @onclick="ToggleFullScreen" disabled="@pendingPdfRender"
                            aria-label="@FullScreenButtonLabel" title="@FullScreenButtonLabel">
                        <i class="bi @(isFullScreen ? "bi-fullscreen-exit" : "bi-arrows-fullscreen")"></i>
                    </button>
                </div>

                <!-- PDF Canvas Container -->
                <div class="document-container">
                    <div id="@pdfContainerId" class="pdfjs-viewer">
                        <div class="pdfjs-loading text-muted text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF...</div>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-muted small mt-2">
            ‡∏´‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        </p>
        if (isFullScreen)
        {
            <div class="pdf-fullscreen-overlay" tabindex="0" @onkeydown="HandleFullScreenKeyDown" @ref="fullScreenOverlayRef">
                <div class="pdf-fullscreen-toolbar d-flex align-items-center justify-content-between">
                    <div class="pdf-fullscreen-title text-truncate" title="@document?.DisplayName">@document?.DisplayName</div>
                    <button class="btn btn-sm btn-light" @onclick="ExitFullScreen" aria-label="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="pdf-fullscreen-body">
                    <div class="pdf-fullscreen-canvas-wrapper">
                        @if (fullScreenRenderFailed)
                        {
                            <iframe src="@previewSource" class="pdf-fullscreen-iframe" title="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠"></iframe>
                        }
                        else
                        {
                            <canvas id="@fullScreenCanvasId" class="pdf-fullscreen-canvas"></canvas>
                        }
                    </div>
                </div>
                @if (HasPageControls)
                {
                    <div class="pdf-fullscreen-nav">
                        <button class="btn btn-lg btn-outline-light" @onclick="PreviousPage" disabled="@(!CanGoPrevious)" aria-label="‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="pdf-fullscreen-page-indicator">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà @currentPage / @totalPages</span>
                        <button class="btn btn-lg btn-outline-light" @onclick="NextPage" disabled="@(!CanGoNext)" aria-label="‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="alert alert-info" role="alert">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        </div>
    }
}

@code {
    [Parameter] public string Token { get; set; } = string.Empty;

    private bool isLoading = true;
    private string? errorMessage;
    private DocumentRecord? document;
    private DocumentCatalogService.DocumentFileHandle? fileHandle;
    private string? previewSource;
    private string? downloadSource;
    private bool canPreviewInline;
    private bool pendingPdfRender;
    private int pdfRenderAttempts;
    private readonly string pdfContainerId = $"pdfjs-viewer-{System.Guid.NewGuid():N}";
    private readonly string fullScreenCanvasId = $"pdf-fullscreen-canvas-{System.Guid.NewGuid():N}";
    private const int MaxPdfRenderAttempts = 3;
    private bool isFullScreen;
    private bool shouldFocusOverlay;
    private bool needsFullScreenRender;
    private bool hasPageData;
    private bool fullScreenRenderFailed;
    private int totalPages = 1;
    private int currentPage = 1;
    private bool isPdfReady;
    private ElementReference fullScreenOverlayRef;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        errorMessage = null;
        document = null;
        fileHandle = null;
        previewSource = null;
        downloadSource = null;
        canPreviewInline = false;
        pendingPdfRender = false;
        pdfRenderAttempts = 0;
        isFullScreen = false;
        shouldFocusOverlay = false;
        needsFullScreenRender = false;
        hasPageData = false;
        fullScreenRenderFailed = false;
        totalPages = 1;
        currentPage = 1;
        isPdfReady = false;

        if (!DocumentCatalogService.TryDecodeDocumentToken(Token, out var normalizedPath))
        {
            errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ";
            isLoading = false;
            return;
        }

        try
        {
            document = await DocumentCatalog.TryGetDocumentAsync(normalizedPath);
            if (document is null)
            {
                errorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π";
                return;
            }

            fileHandle = await DocumentCatalog.TryGetDocumentFileAsync(normalizedPath);
            if (fileHandle is null)
            {
                errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ";
                return;
            }

            var cacheBust = (document?.UpdatedAt?.UtcTicks ?? DateTimeOffset.UtcNow.UtcTicks).ToString();
            previewSource = $"/documents/preview/{Uri.EscapeDataString(Token)}?v={cacheBust}";
            downloadSource = $"/documents/download/{Uri.EscapeDataString(Token)}?v={cacheBust}";
            canPreviewInline = string.Equals(fileHandle.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase);
            pendingPdfRender = canPreviewInline && !string.IsNullOrEmpty(previewSource);
            pdfRenderAttempts = 0;
        }
        catch (OperationCanceledException)
        {
            errorMessage = "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to open document '{DocumentPath}'", normalizedPath);
            errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && pendingPdfRender && !string.IsNullOrEmpty(previewSource))
        {
            pendingPdfRender = false;
            try
            {
                pdfRenderAttempts++;
                await JSRuntime.InvokeVoidAsync("pdfViewer.ready");
                await JSRuntime.InvokeVoidAsync("pdfViewer.render", previewSource!, pdfContainerId);
                isPdfReady = true;
                if (isFullScreen)
                {
                    needsFullScreenRender = true;
                }
            }
            catch (JSException jsEx)
            {
                Logger.LogError(jsEx, "Failed to render PDF preview for '{DocumentPath}'", document?.FileName);
                if (pdfRenderAttempts < MaxPdfRenderAttempts)
                {
                    pendingPdfRender = true;
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Unexpected error while rendering PDF preview for '{DocumentPath}'", document?.FileName);
                if (pdfRenderAttempts < MaxPdfRenderAttempts)
                {
                    pendingPdfRender = true;
                    await InvokeAsync(StateHasChanged);
                }
            }
        }

        if (isFullScreen && needsFullScreenRender)
        {
            needsFullScreenRender = false;
            await RenderCurrentPageAsync();
        }

        if (isFullScreen && shouldFocusOverlay)
        {
            shouldFocusOverlay = false;
            await JSRuntime.InvokeVoidAsync("pdfViewer.focusElement", fullScreenOverlayRef);
        }
    }

    // ===== Toolbar actions (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ quote ‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ô markup) =====
    private Task ZoomIn() => JSRuntime.InvokeVoidAsync("pdfViewer.zoomIn", pdfContainerId).AsTask();
    private Task ZoomOut() => JSRuntime.InvokeVoidAsync("pdfViewer.zoomOut", pdfContainerId).AsTask();
    private Task FitWidth() => JSRuntime.InvokeVoidAsync("pdfViewer.fitWidth", pdfContainerId).AsTask();

    private string FullScreenButtonLabel => isFullScreen ? "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠" : "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠";
    private bool HasPageControls => hasPageData && !fullScreenRenderFailed;
    private bool CanGoNext => HasPageControls && currentPage < totalPages;
    private bool CanGoPrevious => HasPageControls && currentPage > 1;

    private Task ToggleFullScreen()
        => isFullScreen ? ExitFullScreen() : EnterFullScreenAsync();

    private async Task EnterFullScreenAsync()
    {
        if (!canPreviewInline)
        {
            return;
        }

        fullScreenRenderFailed = false;

        try
        {
            totalPages = await JSRuntime.InvokeAsync<int>("pdfViewer.getPageCount", pdfContainerId);
            hasPageData = totalPages > 0;
            if (!hasPageData)
            {
                totalPages = 1;
            }
        }
        catch (JSException jsEx)
        {
            Logger.LogWarning(jsEx, "Unable to determine PDF page count for '{DocumentPath}' in full screen", document?.FileName);
            hasPageData = false;
            totalPages = 1;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Unexpected error determining PDF page count for '{DocumentPath}'", document?.FileName);
            hasPageData = false;
            totalPages = 1;
        }

        currentPage = hasPageData
            ? Math.Clamp(currentPage, 1, totalPages)
            : 1;

        isFullScreen = true;
        shouldFocusOverlay = true;
        needsFullScreenRender = true;

        await InvokeAsync(StateHasChanged);
    }

    private Task ExitFullScreen()
    {
        isFullScreen = false;
        shouldFocusOverlay = false;
        needsFullScreenRender = false;
        return InvokeAsync(StateHasChanged);
    }

    private async Task NextPage() => await ChangePageAsync(1);
    private async Task PreviousPage() => await ChangePageAsync(-1);

    private async Task ChangePageAsync(int delta)
    {
        if (!HasPageControls)
        {
            return;
        }

        var newPage = Math.Clamp(currentPage + delta, 1, totalPages);
        if (newPage == currentPage)
        {
            return;
        }

        currentPage = newPage;
        await InvokeAsync(StateHasChanged);
        await RenderCurrentPageAsync();
    }

    private async Task HandleFullScreenKeyDown(KeyboardEventArgs args)
    {
        if (!isFullScreen)
        {
            return;
        }

        switch (args.Key)
        {
            case "Escape":
                await ExitFullScreen();
                break;
            case "ArrowLeft":
                await PreviousPage();
                break;
            case "ArrowRight":
                await NextPage();
                break;
        }
    }

    private async Task RenderCurrentPageAsync()
    {
        if (!isFullScreen || fullScreenRenderFailed)
        {
            return;
        }

        if (!isPdfReady)
        {
            needsFullScreenRender = true;
            return;
        }

        try
        {
            await JSRuntime.InvokeVoidAsync("pdfViewer.renderPageToCanvas", pdfContainerId, currentPage, fullScreenCanvasId);
        }
        catch (JSException jsEx)
        {
            Logger.LogWarning(jsEx, "Failed to render PDF page {Page} in full screen for '{DocumentPath}'", currentPage, document?.FileName);
            fullScreenRenderFailed = true;
            hasPageData = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Unexpected error while rendering PDF page {Page} in full screen for '{DocumentPath}'", currentPage, document?.FileName);
            fullScreenRenderFailed = true;
            hasPageData = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string DisplayOrDash(string? value)
        => string.IsNullOrWhiteSpace(value) || value == "-" ? "-" : value!;

    private static string FormatTimestamp(DateTimeOffset? timestamp)
        => timestamp.HasValue
            ? timestamp.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            : "-";

    private static string FormatStampInfo(StampMode mode, DateOnly? date)
        => StampDisplay.GetDisplayText(mode, date);

    private void NavigateHome() => Navigation.NavigateTo("/");
}
