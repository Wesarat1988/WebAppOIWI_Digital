@page "/documents/viewer/{Token}"
@rendermode InteractiveServer
@using System.Linq
@inject DocumentCatalogService DocumentCatalog
@inject NavigationManager Navigation
@inject ILogger<WepAppOIWI_Digital.Components.Pages.DocumentViewer> Logger

<PageTitle>‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</PageTitle>

<h1 class="mb-3">üëÅÔ∏è‚Äçüó®Ô∏è ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ OI/WI</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}
else if (isLoading)
{
    <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</p>
}
else if (document is null || fileHandle is null)
{
    <div class="alert alert-warning" role="alert">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á</div>
}
else
{
    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                    <h2 class="card-title h4 mb-1">@document.DisplayName</h2>
                    <p class="card-subtitle text-muted small mb-0">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: @FormatTimestamp(document.UpdatedAt)</p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-primary" href="@(downloadSource ?? "#")" target="_blank" rel="noopener" download="@fileHandle?.FileName">
                        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                    </a>
                    <button type="button" class="btn btn-secondary" @onclick="NavigateHome">
                        ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>
            </div>
            <hr />
            <dl class="row mb-0">
                <dt class="col-sm-3">Line</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Line)</dd>
                <dt class="col-sm-3">Station</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Station)</dd>
                <dt class="col-sm-3">Model</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.Model)</dd>
                <dt class="col-sm-3">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</dt>
                <dd class="col-sm-9">@DisplayOrDash(document.UploadedBy)</dd>
                <dt class="col-sm-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå</dt>
                <dd class="col-sm-9">@fileHandle.ContentType</dd>
            </dl>
        </div>
    </div>

    @if (canPreviewInline && !string.IsNullOrEmpty(previewSource))
    {
        <div class="document-preview-frame border rounded overflow-hidden">
            <iframe src="@previewSource" title="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"></iframe>
        </div>
        <p class="text-muted small mt-2">
            ‡∏´‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        </p>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        </div>
    }
}

@code {
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private bool isLoading = true;
    private string? errorMessage;
    private DocumentRecord? document;
    private DocumentCatalogService.DocumentFileHandle? fileHandle;
    private string? previewSource;
    private string? downloadSource;
    private bool canPreviewInline;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        errorMessage = null;
        document = null;
        fileHandle = null;
        previewSource = null;
        downloadSource = null;
        canPreviewInline = false;

        if (!DocumentCatalogService.TryDecodeDocumentToken(Token, out var normalizedPath))
        {
            errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ";
            isLoading = false;
            return;
        }

        try
        {
            var records = await DocumentCatalog.GetDocumentsAsync();
            document = records.FirstOrDefault(r => string.Equals(r.FileName, normalizedPath, StringComparison.OrdinalIgnoreCase));
            if (document is null)
            {
                errorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π";
                return;
            }

            fileHandle = await DocumentCatalog.TryGetDocumentFileAsync(normalizedPath);
            if (fileHandle is null)
            {
                errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ";
                return;
            }

            previewSource = $"/documents/preview/{Uri.EscapeDataString(Token)}";
            downloadSource = $"/documents/download/{Uri.EscapeDataString(Token)}";
            canPreviewInline = string.Equals(fileHandle.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase);
        }
        catch (OperationCanceledException)
        {
            errorMessage = "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to open document '{DocumentPath}'", normalizedPath);
            errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        }
        finally
        {
            isLoading = false;
        }
    }

    private static string DisplayOrDash(string? value)
        => string.IsNullOrWhiteSpace(value) || value == "-"
            ? "-"
            : value!;

    private static string FormatTimestamp(DateTimeOffset? timestamp)
        => timestamp.HasValue
            ? timestamp.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            : "-";

    private void NavigateHome()
        => Navigation.NavigateTo("/");
}
